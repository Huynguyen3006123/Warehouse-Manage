<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/product.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="js/jquery-3.7.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Trang chính</h2>
        <ul>
            <li><a href="#" class="menu-link" data-page="apiNV/get_account_self.php">Thông Tin Tài Khoản</a></li>
            <li><a href="#" class="menu-link" data-page="apiNV/get_sanpham.php">Sản Phẩm</a></li>
            <li><a href="#" class="menu-link" data-page="apiNV/get_yeucau.php">Yêu Cầu Nhập Hàng</a></li>
            <li><a href="#" class="menu-link" data-page="apiNV/get_donhang.php">Duyệt Đơn Hàng</a></li>
            <li><a href="#" class="menu-link" data-page="apiNV/get_xuat.php">Xuất Kho</a></li>
        </ul>
        <a href="logout.php" class="logout-btn">Đăng xuất</a>
    </div>

    <!-- Nội dung chính -->
    <div id="content">
        <div class="main-contents">
            <!-- Nội dung động sẽ được tải vào đây -->
        </div>
    </div>

    <!-- Modal Sửa Thông Tin Tài Khoản -->
    <div id="editAccountModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chỉnh Sửa Tài Khoản</h2>
            <form id="editAccountForm">
                <input type="hidden" name="UserID">
    
                <div class="input-group">
                    <label for="UserName">Tên tài khoản</label>
                    <input type="text" name="UserName" placeholder="UserName" required>
                </div>
    
                <div class="input-group">
                    <label for="PassWord">Mật khẩu mới</label>
                    <input type="password" name="PassWord" placeholder="Nhập mật khẩu mới (để trống nếu không đổi)">
                </div>
    
                <button type="submit" class="submit-btn">Cập nhật Tài Khoản</button>
            </form>
        </div>
    </div>
<!-- Modal Tạo Yêu Cầu Nhập Hàng -->
<div id="addRequestModal" class="modal" style="display: none;">
  <div class="modal-content">

    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Tạo Báo Cáo Nhập Hàng</h2>
    <form id="addRequestForm">
      <!-- Hidden -->
      <input type="hidden" name="MaPN" id="MaPN">
      <input type="hidden" name="MaNV" id="MaNV">

      <div class="input-group1">
        <label for="MaNCC">Nhà Cung Cấp</label>
        <select name="MaNCC" id="MaNCC" required>
          <option value="">Chọn Nhà Cung Cấp</option>
        </select>
      </div>

      <div class="input-group1">
        <label for="NgayNhap">Ngày Nhập</label>
        <input type="date" name="NgayNhap" id="NgayNhap" readonly>
      </div>

      <h4>Chi Tiết Sản Phẩm</h4>
      <div id="productDetails">
        <div class="product-detail">
          <div class="input-group1">
            <label for="MaSP">Sản Phẩm</label>
            <select name="MaSP[]" class="product-select" required>
              <option value="">Chọn Sản Phẩm</option>
            </select>
          </div>
          <div class="input-group1">
            <label for="SoLuongNhap">Số Lượng Nhập</label>
            <input type="number" name="SoLuongNhap[]" class="quantity-input" placeholder="Số Lượng Nhập" required>
          </div>
          <button type="button" class="remove-product-btn" onclick="removeProductRow(this)" style="display: none;">Xóa</button>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="submit-btn1" id="addProductDetailBtn">+ Thêm Sản Phẩm</button>
        <button type="submit" class="submit-btn1">Tạo Báo Cáo</button>
      </div>
    </form>
  </div>
</div>
    <!-- Modal Chi tiết Yêu Cầu Nhập Hàng -->
    <div id="detailRequestModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h2>Chi Tiết Phiếu Nhập</h2>
            <table class="product-table">
                <thead>
                    <tr>
                        <th>Mã Phiếu Nhập</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Số Lượng Nhập</th>
                    </tr>
                </thead>
                <tbody id="detailRequestBody">
                    <!-- Dữ liệu sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Modal Chi tiết Đơn Hàng -->
    <div id="detailOrderModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h3>Chi tiết đơn hàng</h3>
            <table id="detailOrderTable" class="product-table">
                <thead>
                    <tr>
                        <th>Mã Phiếu Xuất</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Tên Sản Phẩm</th>
                        <th>Số Lượng Xuất</th>
                        <th>Giá Xuất</th>
                        <th>Thành Tiền</th>
                    </tr>
                </thead>
                <tbody id="detailOrderBody">
                    <!-- Dữ liệu chi tiết sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Modal Chi tiết Xuất kho -->
    <div id="detailExportModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h3>Chi tiết sản phẩm xuất kho</h3>
            <table id="detailExportTable" class="product-table">
                <thead>
                    <tr>
                        <th>Mã Phiếu Xuất</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Tên Sản Phẩm</th>
                        <th>Số Lượng Xuất</th>
                        <th>Giá Xuất</th>
                        <th>Thành Tiền</th>
                    </tr>
                </thead>
                <tbody id="detailExportBody">
                    <!-- Dữ liệu chi tiết sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        $(document).ready(function () {


            // // Load trang mặc định
            // loadPage("apiNV/get_account_self.php");
            console.log("Trang dashboardNV.html đã tải, đang kiểm tra session...");

            // Kiểm tra session ngay khi trang được tải
            $.ajax({
                url: "apiNV/get_account_self.php",
                type: "GET",
                dataType: "json",
                cache: false, // Tắt cache để đảm bảo yêu cầu luôn mới
                success: function (data) {
                    console.log("Phản hồi từ get_account_self.php:", data);
                    if (data.success) {
                        console.log("Session hợp lệ, tải trang mặc định...");
                        loadPage("apiNV/get_account_self.php");
                    } else {
                        console.log("Session không hợp lệ, chuyển hướng về login...");
                        window.location.href = "login.html";
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Lỗi khi gọi API:", error);
                    window.location.href = "login.html";
                }
            });

            // Xử lý click menu
            $(".menu-link").click(function (e) {
                e.preventDefault();
                var page = $(this).data("page");
                loadPage(page);
            });

            // Hàm đóng modal chung
            function setupModalClose(modalId) {
                $(`#${modalId} .close`).on("click", function () {
                    $(`#${modalId}`).fadeOut();
                });
                $(window).on("click", function (event) {
                    if ($(event.target).is(`#${modalId}`)) {
                        $(`#${modalId}`).fadeOut();
                    }
                });
            }
            function showToast(message, isError = false) {
            const toast = $("#toast");
            toast.css("background", isError ? "#dc3545" : "#28a745");
            toast.text(message).fadeIn();

            setTimeout(() => {
                toast.fadeOut();
            }, 3000);
         }
            // Thiết lập đóng modal cho tất cả modal
            setupModalClose("editAccountModal");
            setupModalClose("addRequestModal");
            setupModalClose("detailRequestModal");
            setupModalClose("detailOrderModal");
            setupModalClose("detailExportModal");
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function loadPage(page) {
                // 1. Thông Tin Tài Khoản
                if (page === "apiNV/get_account_self.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            if (data.success && data.data) {
                                let account = data.data;
                                // Sử dụng placeholder 3x4 nếu không có hình ảnh
                                let userImage = account.Image ? account.Image : "https://placehold.co/150x200?text=User+Image"; // Placeholder 3x4 (150x200)

                                let contentHtml = `
                                    <div class="table-container">
                                        <h2>Thông Tin Tài Khoản</h2>
                                        <img src="${userImage}" alt="User Image" class="user-image">
                                        <div class="account-info">
                                            <label><strong>ID:</strong> ${account.UserID}</label><br>
                                            <label><strong>Tên Đăng Nhập:</strong> ${account.UserName}</label><br>
                                        </div>
                                        <button class="edit-btn" data-id="${account.UserID}">Sửa Thông Tin</button>
                                    </div>
                                `;
                                $("#content .main-contents").html(contentHtml);

                                $(".edit-btn").off("click").on("click", function () {
                                    const userId = $(this).data("id");
                                    $("#editAccountForm input[name='UserID']").val(account.UserID);
                                    $("#editAccountForm input[name='UserName']").val(account.UserName);
                                    $("#editAccountForm input[name='PassWord']").val("");
                                    $("#editAccountModal").fadeIn();
                                });

                                $("#editAccountForm").off("submit").on("submit", function (event) {
                                    event.preventDefault();
                                    $.ajax({
                                        type: "POST",
                                        url: "apiNV/editAccount.php",
                                        data: $(this).serialize(),
                                        success: function (response) {
                                            if (response.success) {
                                                showToast("Tài khoản đã được cập nhật!");
                                                $("#editAccountModal").fadeOut();
                                                loadPage("apiNV/get_account_self.php");
                                            } else {
                                                showToast("Cập nhật thất bại: " + (response.message || "Lỗi không xác định"));
                                            }
                                        },
                                        error: function () {
                                            showToast("Lỗi khi kết nối đến server!");
                                        }
                                    });
                                });
                            } else {
                                $("#content .main-contents").html("<p>Không tìm thấy thông tin tài khoản!</p>");
                            }
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                // 2. Xem Sản Phẩm (chỉ trạng thái show)
                else if (page === "apiNV/get_sanpham.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã SP</th>
                                                <th>Tên SP</th>
                                                <th>Loại SP</th>
                                                <th>Kích Cỡ</th>
                                                <th>Màu sắc</th>
                                                <th>Giá nhập</th>
                                                <th>Giá xuất</th>
                                                <th>Số lượng còn lại</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            data.forEach(product => {
                                contentHtml += `
                                    <tr>
                                        <td>${product.MaSP}</td>
                                        <td>${product.TenSP}</td>
                                        <td>${product.LoaiSP}</td>
                                        <td>${product.KichCo}</td>
                                        <td>${product.MauSac}</td>
                                        <td>${product.GiaNhap.toLocaleString('vi-VN')}</td>
                                        <td>${product.GiaXuat.toLocaleString('vi-VN')}</td>
                                        <td>${product.SoLuongTon}</td>
                                    </tr>
                                `;
                            });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                // 3. Xem Yêu Cầu Nhập Hàng (pending và denied)
                else if (page === "apiNV/get_yeucau.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Nhập</th>
                                                <th>Nhà Cung Cấp</th>
                                                <th>Ngày Nhập</th>
                                                <th>Mã Nhân Viên</th>
                                                <th>Trạng Thái</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(request => {
                                    contentHtml += `
                                        <tr>
                                            <td>${request.MaPN}</td>
                                            <td>${request.MaNCC}</td>
                                            <td>${request.NgayNhap}</td>
                                            <td>${request.MaNV}</td>
                                            <td>${request.TrangThai}</td>
                                            <td>
                                                <button class="detail-btn" data-id="${request.MaPN}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="7">Không có yêu cầu nhập kho</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                    <button id="addRequestBtn" class="addRequestBtn">Tạo Báo Cáo Nhập Hàng</button>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý nút Tạo Yêu Cầu
                            $("#addRequestBtn").off("click").on("click", function () {
                                // Load danh sách nhà cung cấp
                                $.ajax({
                                    url: "apiNV/get_nhacungcap.php",
                                    type: "GET",
                                    dataType: "json",
                                    success: function (nccList) {
                                        let options = '<option value="">Chọn Nhà Cung Cấp</option>';
                                        nccList.forEach(ncc => {
                                            options += `<option value="${ncc.MaNCC}">${ncc.TenNCC} (${ncc.MaNCC})</option>`;
                                        });
                                        $("#MaNCC").html(options);
                                    },
                                    error: function () {
                                        showToast("Lỗi khi tải danh sách nhà cung cấp!");
                                    }
                                });

                                // Load danh sách sản phẩm
                                $.ajax({
                                    url: "apiNV/get_sanpham.php",
                                    type: "GET",
                                    dataType: "json",
                                    success: function (products) {
                                        let options = '<option value="">Chọn Sản Phẩm</option>';
                                        products.forEach(product => {
                                            options += `<option value="${product.MaSP}">${product.TenSP} (${product.SoLuongTon})</option>`;
                                        });
                                        // Gán danh sách sản phẩm cho tất cả select hiện có
                                        $("#addRequestForm select[name='MaSP[]']").html(options);
                                    },
                                    error: function () {
                                        showToast("Lỗi khi tải danh sách sản phẩm!");
                                    }
                                });

                                // Tự động sinh Mã Phiếu Nhập (MaPN)
                                $.ajax({
                                    url: "apiNV/generate_ma.php",
                                    type: "GET",
                                    data: { type: "PhieuNhap" },
                                    dataType: "json",
                                    success: function (response) {
                                        if (response.success) {
                                            $("#MaPN").val(response.MaPN);
                                        } else {
                                            showToast("Lỗi khi sinh Mã Phiếu Nhập!");
                                        }
                                    },
                                    error: function () {
                                        showToast("Lỗi khi sinh Mã Phiếu Nhập!");
                                    }
                                });

                                // Tự động điền ngày hiện tại
                                const today = new Date();
                                $("#NgayNhap").val(formatDate(today));

                                $("#addRequestModal").fadeIn();
                            });

                            // Xử lý nút "Thêm Sản Phẩm"
                            $("#addProductDetailBtn").off("click").on("click", function () {
                                const productDetail = $(".product-detail:first").clone();
                                productDetail.find("select").val(""); // Reset giá trị select
                                productDetail.find("input[type='number']").val(""); // Reset số lượng
                                productDetail.find(".remove-product-btn").show(); // Hiển thị nút xóa
                                $("#productDetails").append(productDetail);

                                // Load lại danh sách sản phẩm cho select mới
                                $.ajax({
                                    url: "apiNV/get_sanpham.php",
                                    type: "GET",
                                    dataType: "json",
                                    success: function (products) {
                                        let options = '<option value="">Chọn Sản Phẩm</option>';
                                        products.forEach(product => {
                                            options += `<option value="${product.MaSP}">${product.TenSP} (${product.SoLuongTon})</option>`;
                                        });
                                        productDetail.find("select[name='MaSP[]']").html(options);
                                    }
                                });
                            });

                            // Xử lý nút "Xóa Sản Phẩm"
                            $("#productDetails").on("click", ".remove-product-btn", function () {
                                if ($(".product-detail").length > 1) {
                                    $(this).closest(".product-detail").remove();
                                }
                            });

                            // Xử lý submit form tạo yêu cầu
                            $("#addRequestForm").off("submit").on("submit", function (event) {
                                event.preventDefault();
                                $.ajax({
                                    type: "POST",
                                    url: "apiNV/addRequest.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        if (response.success) {
                                            showToast("Yêu cầu nhập hàng đã được tạo!");
                                            $("#addRequestModal").fadeOut();
                                            loadPage("apiNV/get_yeucau.php");
                                        } else {
                                            showToast("Tạo yêu cầu thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function () {
                                        showToast("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });

                            // Đóng modal
                            $(".close").on("click", function () {
                                $("#addRequestModal").fadeOut();
                            });

                            $(window).on("click", function (event) {
                                if ($(event.target).is("#addRequestModal")) {
                                    $("#addRequestModal").fadeOut();
                                }
                            });

                            // Hàm format ngày (giả định bạn đã có)
                            function formatDate(date) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, "0");
                                const day = String(date.getDate()).padStart(2, "0");
                                return `${year}-${month}-${day}`;
                            }
                            // Xử lý nút Chi Tiết
                            $(".detail-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "apiNV/get_chitietyeucau.php",
                                    type: "GET",
                                    data: { MaPN: requestId },
                                    dataType: "json",
                                    success: function (response) {
                                        if (response.success) {
                                            $("#detailRequestBody").empty();
                                            if (Array.isArray(response.data) && response.data.length > 0) {
                                                response.data.forEach(product => {
                                                    $("#detailRequestBody").append(`
                                                        <tr>
                                                            <td>${product.MaPN}</td>
                                                            <td>${product.MaSP}</td>
                                                            <td>${product.SoLuongNhap}</td>
                                                        </tr>
                                                    `);
                                                });
                                            } else {
                                                $("#detailRequestBody").append(`
                                                    <tr>
                                                        <td colspan="5">Không có sản phẩm nào cho phiếu nhập này</td>
                                                    </tr>
                                                `);
                                            }
                                            $("#detailRequestModal").fadeIn();
                                        } else {
                                            showToast("Lấy chi tiết thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function () {
                                        showToast("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });
                            $(".close").on("click", function () {
                                $("#detailRequestModal").fadeOut();
                            });

                            $(window).on("click", function (event) {
                                if ($(event.target).is("#detailRequestModal")) {
                                    $("#detailRequestModal").fadeOut();
                                }
                            });

                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                // 4. Duyệt Đơn Hàng Từ Cửa Hàng
                else if (page === "apiNV/get_donhang.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Xuất</th>
                                                <th>Mã Cửa Hàng</th>
                                                <th>Ngày Đặt</th>
                                                <th>Trạng Thái</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(order => {
                                    contentHtml += `
                                        <tr>
                                            <td>${order.MaPX}</td>
                                            <td>${order.MaCH}</td>
                                            <td>${order.NgayXuat}</td>
                                            <td>
                                                ${order.TrangThai === 'pending' ?
                                            `<button class="approve-btn" data-id="${order.MaPX}">Duyệt</button>` :
                                            order.TrangThai}
                                            </td>
                                            <td>
                                                <button class="detail-btn" data-id="${order.MaPX}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="6">Không có đơn hàng đang chờ xử lý</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            $(".approve-btn").off("click").on("click", function () {
                                const orderId = $(this).data("id");
                                const currentDate = new Date().toISOString().split('T')[0]; // Lấy ngày hiện tại dạng YYYY-MM-DD
                                $.ajax({
                                    url: "apiNV/approve_order.php",
                                    type: "POST",
                                    data: { 
                                        MaPX: orderId,
                                        NgayXuat: currentDate // Gửi ngày hiện tại
                                    },
                                    success: function (response) {
                                        if (response.success) {
                                            showToast("Phiếu xuất đã được duyệt!");
                                            loadPage("apiNV/get_donhang.php");
                                        } else {
                                            showToast("Duyệt phiếu xuất thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function () {
                                        showToast("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });

                            $(".detail-btn").off("click").on("click", function () {
                                const orderId = $(this).data("id");
                                $.ajax({
                                    url: "apiNV/get_chitietdonhang.php",
                                    type: "GET",
                                    data: { MaPX: orderId },
                                    dataType: "json",
                                    success: function (response) {
                                        console.log("Phản hồi từ get_chitietdonhang.php:", response); // Debug
                                        if (response.success) {
                                            $("#detailOrderBody").empty();
                                            if (Array.isArray(response.data) && response.data.length > 0) {
                                                response.data.forEach(product => {
                                                    $("#detailOrderBody").append(`
                                                        <tr>
                                                            <td>${product.MaPX}</td>
                                                            <td>${product.MaSP}</td>
                                                            <td>${product.TenSP}</td>
                                                            <td>${product.SoLuongXuat}</td>
                                                            <td>${product.DonGia.toLocaleString('vi-VN')}</td>
                                                            <td>${product.ThanhTien.toLocaleString('vi-VN')}</td>
                                                        </tr>
                                                    `);
                                                });
                                            } else {
                                                $("#detailOrderBody").append(`
                                                    <tr>
                                                        <td colspan="6">Không có sản phẩm nào cho phiếu xuất này</td>
                                                    </tr>
                                                `);
                                            }
                                            $("#detailOrderModal").fadeIn();
                                        } else {
                                            showToast("Lấy chi tiết thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Lỗi AJAX:", status, error); // Debug
                                        showToast("Lỗi khi lấy chi tiết phiếu xuất!");
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                // 5. Xem Xuất Kho Theo MaNV
                else if (page === "apiNV/get_xuat.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Xuất</th>
                                                <th>Ngày Xuất</th>
                                                <th>Mã Nhân Viên</th>
                                                <th>Mã Cửa Hàng</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data.data) && data.data.length > 0) {
                                data.data.forEach(xuat => {
                                    contentHtml += `
                                        <tr>
                                            <td>${xuat.MaPX}</td>
                                            <td>${xuat.NgayXuat}</td>
                                            <td>${xuat.MaNV}</td>
                                            <td>${xuat.MaCH}</td>
                                            <td>
                                                <button class="detail-btn" data-id="${xuat.MaPX}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="6">Không có phiếu xuất đã xác nhận nào</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            $(".detail-btn").off("click").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "apiNV/get_chitietxuat.php",
                                    type: "GET",
                                    data: { MaPX: requestId },
                                    dataType: "json",
                                    success: function (response) {
                                        if (response.success) {
                                            $("#detailExportBody").empty();
                                            if (Array.isArray(response.data) && response.data.length > 0) {
                                                response.data.forEach(product => {
                                                    $("#detailExportBody").append(`
                                                        <tr>
                                                            <td>${product.MaPX}</td>
                                                            <td>${product.MaSP}</td>
                                                            <td>${product.TenSP}</td>
                                                            <td>${product.SoLuongXuat}</td>
                                                            <td>${product.DonGia.toLocaleString('vi-VN')}</td>
                                                            <td>${product.ThanhTien.toLocaleString('vi-VN')}</td>
                                                        </tr>
                                                    `);
                                                });
                                            } else {
                                                $("#detailExportBody").append(`
                                                    <tr>
                                                        <td colspan="6">Không có sản phẩm nào cho phiếu xuất này</td>
                                                    </tr>
                                                `);
                                            }
                                            $("#detailExportModal").fadeIn();
                                        } else {
                                            showToast("Lấy chi tiết thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Lỗi AJAX chi tiết:", status, error);
                                        showToast("Lỗi khi lấy chi tiết sản phẩm xuất kho!");
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                
            }
        });
    </script>
        <div id="toast" style="display:none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999;"></div>

</body>

</html>