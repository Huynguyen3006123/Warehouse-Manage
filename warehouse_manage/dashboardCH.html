<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/product.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="js/jquery-3.7.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Trang chính</h2>
        <ul>
            <li><a href="#" class="menu-link" data-page="apiCH/get_sanpham.php">Sản Phẩm</a></li>
            <li><a href="#" class="menu-link" data-page="apiCH/get_phieuxuat.php">Đơn Hàng</a></li>
        </ul>
        <a href="logout.php" class="logout-btn">Đăng xuất</a>
    </div>

    <!-- Nội dung chính -->
    <div id="content">
        <div class="main-contents">
            <!-- Nội dung động sẽ được tải vào đây -->
        </div>
    </div>

    <!-- Modal Giỏ Hàng -->
    <div id="cartModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h2>Giỏ Hàng</h2>
            <table class="product-table">
                <thead>
                    <tr>
                        <th>Mã Sản Phẩm</th>
                        <th>Số Lượng</th>
                        <th>Đơn Giá</th>
                        <th>Thành Tiền</th>
                        <th>Xoá Sản Phẩm</th> <!-- Thêm cột Hành Động -->
                    </tr>
                </thead>
                <tbody id="cartItems">
                    <!-- Dữ liệu sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
            <div class="cart-actions" id="cartActions" style="display: none;">
                <p>Thành Tiền: <span id="totalPrice">0</span> VNĐ</p>
                <button id="placeOrderBtn" class="cart-btn">Đặt Hàng</button>
            </div>
        </div>
    </div>

    <!-- Modal Chi tiết Đơn Hàng -->
    <div id="detailOrderModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h3>Chi tiết đơn hàng</h3>
            <table id="detailOrderTable" class="product-table">
                <thead>
                    <tr>
                        <th>Mã Phiếu Xuất</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Tên Sản Phẩm</th>
                        <th>Số Lượng Xuất</th>
                        <th>Giá Xuất</th>
                        <th>Thành Tiền</th>
                    </tr>
                </thead>
                <tbody id="detailOrderBody">
                    <!-- Dữ liệu chi tiết sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Kiểm tra session ngay khi trang được tải
            $.ajax({
                url: "apiCH/check_session.php",
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (data) {
                    console.log("Phản hồi từ apiCH/check_session.php:", data);
                    if (data.success && data.role === "Cửa Hàng") {
                        console.log("Session hợp lệ, tải trang mặc định...");
                        window.maCH = data.maCH;
                        if (!window.maCH) {
                            console.error("Không tìm thấy MaCH trong session");
                            window.location.href = "login.html";
                            return;
                        }
                        loadPage("apiCH/get_sanpham.php");
                    } else {
                        console.log("Session không hợp lệ hoặc không phải Cửa Hàng, chuyển hướng về login...");
                        // Chỉ chuyển hướng nếu không phải đang ở login.html
                        const currentPage = window.location.pathname.split('/').pop();
                        if (currentPage !== 'login.html') {
                            window.location.href = "login.html";
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Lỗi khi gọi API apiCH/check_session.php:", error);
                    // Chỉ chuyển hướng nếu không phải đang ở login.html
                    const currentPage = window.location.pathname.split('/').pop();
                    if (currentPage !== 'login.html') {
                        window.location.href = "login.html";
                    }
                }
            });

            // Xử lý click menu
            $(".menu-link").click(function (e) {
                e.preventDefault();
                var page = $(this).data("page");
                loadPage(page);
            });
            // Hàm đóng modal chung
            function setupModalClose(modalId) {
                $(`#${modalId} .close`).on("click", function () {
                    $(`#${modalId}`).fadeOut();
                });
                $(window).on("click", function (event) {
                    if ($(event.target).is(`#${modalId}`)) {
                        $(`#${modalId}`).fadeOut();
                    }
                });
            }
            $("#placeOrderBtn").on("click", function () {
                $.ajax({
                    url: "apiCH/place_order.php",
                    type: "POST",
                    dataType: "json",
                    success: function (response) {
                        console.log("Phản hồi từ place_order.php:", response);
                        if (response.success) {
                            alert("Đặt hàng thành công! Mã phiếu xuất: " + response.maPX);
                            $("#cartModal").fadeOut();
                            loadPage("apiCH/get_sanpham.php");
                        } else {
                            alert("Đặt hàng thất bại: " + (response.message || "Lỗi không xác định"));
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi khi gọi API place_order.php:", error);
                        console.error("Mã lỗi HTTP:", xhr.status);
                        console.error("Phản hồi từ server:", xhr.responseText);
                        alert("Lỗi khi đặt hàng: " + error);
                    }
                });
            });

            // Thiết lập đóng modal
            setupModalClose("cartModal");
            setupModalClose("detailOrderModal");

            function loadPage(page) {
                // 1. Sản Phẩm
                if (page === "apiCH/get_sanpham.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        data: { status: "show" },
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã SP</th>
                                                <th>Tên SP</th>
                                                <th>Loại SP</th>
                                                <th>Kích Cỡ</th>
                                                <th>Màu sắc</th>
                                                <th>Giá Xuất</th>
                                                <th>Số lượng còn lại</th>
                                                <th>Thêm vào giỏ hàng</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(product => {
                                    contentHtml += `
                                        <tr>
                                            <td>${product.MaSP}</td>
                                            <td>${product.TenSP}</td>
                                            <td>${product.LoaiSP}</td>
                                            <td>${product.KichCo || 'N/A'}</td>
                                            <td>${product.MauSac || 'N/A'}</td>
                                            <td>${product.GiaXuat.toLocaleString('vi-VN')}</td>
                                            <td>${product.SoLuongTon}</td>
                                            <td>
                                                <input type="number" class="quantity-input" data-masp="${product.MaSP}" min="1" required>
                                                <button class="cart-btn add-to-cart-btn" data-masp="${product.MaSP}" data-dongia="${product.GiaXuat}">Thêm</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="8">Không có sản phẩm nào.</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                    <button id="viewCartBtn" class="cart-btn">Xem Giỏ Hàng</button>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý thêm vào giỏ hàng
                            $(".add-to-cart-btn").on("click", function () {
                                const maSP = $(this).data("masp");
                                const soLuongInput = $(this).siblings(".quantity-input").val();
                                const soLuong = parseInt(soLuongInput, 10);
                                const donGia = $(this).data("dongia");

                                // Debug giá trị
                                console.log("maSP:", maSP);
                                console.log("soLuong:", soLuong);
                                console.log("donGia:", donGia);

                                // Kiểm tra dữ liệu trước khi gửi
                                if (typeof maSP === 'undefined' || maSP === null) {
                                    alert("Lỗi: Mã sản phẩm không hợp lệ!");
                                    return;
                                }
                                if (isNaN(soLuong) || soLuong <= 0) {
                                    alert("Số lượng phải là số nguyên lớn hơn 0!");
                                    return;
                                }
                                if (typeof donGia === 'undefined' || donGia === null || donGia <= 0) {
                                    alert("Lỗi: Đơn giá không hợp lệ!");
                                    return;
                                }

                                $.ajax({
                                    url: "apiCH/add_to_cart.php",
                                    type: "POST",
                                    data: { maSP: maSP, soLuong: soLuong, donGia: donGia },
                                    dataType: "json",
                                    success: function (response) {
                                        if (response.success) {
                                            alert("Đã thêm vào giỏ hàng và trừ số lượng tồn!");
                                            loadPage("apiCH/get_sanpham.php");
                                        } else {
                                            alert("Thêm thất bại: " + response.message);
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error("Lỗi khi thêm vào giỏ hàng:", error);
                                        alert("Lỗi khi thêm vào giỏ hàng!");
                                    }
                                });
                            });

                            // Xử lý nút Xem Giỏ Hàng (giữ nguyên)
                            $("#viewCartBtn").on("click", function () {
                                $.ajax({
                                    url: "apiCH/get_cart.php",
                                    type: "GET",
                                    dataType: "json",
                                    success: function (response) {
                                        console.log("Dữ liệu giỏ hàng:", response);
                                        $("#cartItems").empty();
                                        let hasItems = false;
                                        let totalPrice = 0;

                                        if (response.success && response.data && Object.keys(response.data).length > 0) {
                                            hasItems = true;
                                            for (const maSP in response.data) {
                                                const item = response.data[maSP];
                                                const thanhTien = item.soLuong * item.donGia;
                                                totalPrice += thanhTien;

                                                $("#cartItems").append(`
                                                    <tr>
                                                        <td>${maSP}</td>
                                                        <td>${item.soLuong}</td>
                                                        <td>${item.donGia.toLocaleString('vi-VN')}</td>
                                                        <td>${thanhTien.toLocaleString('vi-VN')}</td>
                                                        <td>
                                                            <button class="remove-from-cart-btn" data-masp="${maSP}">-</button>
                                                        </td>
                                                    </tr>
                                                `);
                                            }
                                        } else {
                                            $("#cartItems").append(`
                                                <tr>
                                                    <td colspan="5">Giỏ hàng trống.</td>
                                                </tr>
                                            `);
                                        }

                                        $("#totalPrice").text(totalPrice.toLocaleString('vi-VN'));

                                        if (hasItems) {
                                            $("#cartActions").show();
                                        } else {
                                            $("#cartActions").hide();
                                        }
                                        $("#cartModal").fadeIn();

                                        // Xử lý nút Bỏ sản phẩm
                                        $(".remove-from-cart-btn").on("click", function () {
                                            const maSP = $(this).data("masp");
                                            $.ajax({
                                                url: "apiCH/remove_from_cart.php",
                                                type: "POST",
                                                data: { maSP: maSP },
                                                dataType: "json",
                                                success: function (response) {
                                                    if (response.success) {
                                                        alert("Đã bỏ sản phẩm khỏi giỏ hàng và cộng lại số lượng tồn!");
                                                        $("#viewCartBtn").click();
                                                        loadPage("apiCH/get_sanpham.php");
                                                    } else {
                                                        alert("Bỏ sản phẩm thất bại: " + response.message);
                                                    }
                                                },
                                                error: function (xhr, status, error) {
                                                    console.error("Lỗi khi bỏ sản phẩm khỏi giỏ hàng:", error);
                                                    alert("Lỗi khi bỏ sản phẩm khỏi giỏ hàng!");
                                                }
                                            });
                                        });
                                    },
                                    error: function (xhr, status, error) {
                                        console.error("Lỗi khi gọi API get_cart.php:", error);
                                        alert("Lỗi khi tải giỏ hàng!");
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("Lỗi khi gọi API get_sanpham.php:", error);
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
                // 2. Đơn Hàng
                else if (page === "apiCH/get_phieuxuat.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        data: { MaCH: window.maCH },
                        dataType: "json",
                        success: function (data) {
                            console.log("Dữ liệu phiếu xuất:", data);
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Xuất</th>
                                                <th>Ngày Xuất</th>
                                                <th>Trạng Thái</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(order => {
                                    contentHtml += `
                                        <tr>
                                            <td>${order.MaPX}</td>
                                            <td>${order.NgayXuat}</td>
                                            <td>${order.TrangThai}</td>
                                            <td>
                                                <button class="detail-btn" data-id="${order.MaPX}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="4">Không có đơn hàng nào.</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý nút Chi Tiết
                            $(".detail-btn").on("click", function () {
                                const orderId = $(this).data("id");
                                $.ajax({
                                    url: "apiCH/get_chitietxuat.php",
                                    type: "GET",
                                    data: { MaPX: orderId },
                                    dataType: "json",
                                    success: function (response) {
                                        console.log("Chi tiết phiếu xuất:", response);
                                        if (response.success) {
                                            $("#detailOrderBody").empty();
                                            if (Array.isArray(response.data) && response.data.length > 0) {
                                                response.data.forEach(product => {
                                                    $("#detailOrderBody").append(`
                                                        <tr>
                                                            <td>${product.MaPX}</td>
                                                            <td>${product.MaSP}</td>
                                                            <td>${product.TenSP}</td>
                                                            <td>${product.SoLuongXuat}</td>
                                                            <td>${product.DonGia.toLocaleString('vi-VN')}</td>
                                                            <td>${product.ThanhTien.toLocaleString('vi-VN')}</td>
                                                        </tr>
                                                    `);
                                                });
                                            } else {
                                                $("#detailOrderBody").append(`
                                                    <tr>
                                                        <td colspan="6">Không có sản phẩm nào cho phiếu xuất này.</td>
                                                    </tr>
                                                `);
                                            }
                                            $("#detailOrderModal").fadeIn();
                                        } else {
                                            alert("Lấy chi tiết thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.error("Lỗi khi gọi API get_chitietphieuxuat.php:", error);
                                        alert("Lỗi khi lấy chi tiết phiếu xuất!");
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            console.error("Lỗi khi gọi API get_phieuxuat.php:", error);
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>