<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/product.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="js/jquery-3.7.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h2>Trang chính</h2>
        <ul>
            <li><a href="#" class="menu-link" data-page="api/dashboard.php">Tổng quan</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_sanpham.php">Sản phẩm</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_store.php">Cửa Hàng</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_emp.php">Nhân Viên</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_account.php">Tài Khoản</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_yeucau.php">Yêu Cầu</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_nhap.php">Nhập kho</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_donhang.php">Đơn Hàng</a></li>
            <li><a href="#" class="menu-link" data-page="api/get_xuat.php">Xuất kho</a></li>
        </ul>
        <a href="logout.php" class="logout-btn">Đăng xuất</a>
    </div>

    <!-- Nội dung chính -->
    <div id="content">
        <div class="main-contents">
            <!-- Nội dung động sẽ được tải vào đây -->
        </div>
    </div>
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span> 
            <h2>Thêm sản Phẩm</h2>
            <form id="addProductForm">
                <div class="input-group">
                    <label for="MaSP">Mã Sản Phẩm</label>
                    <input type="number" name="MaSP" placeholder="Nhập mã sản phẩm" required>
                </div>
                <div class="input-group">
                    <label for="TenSP">Tên Sản Phẩm</label>
                    <input type="text" name="TenSP" placeholder="Nhập tên sản phẩm" required>
                </div>
                <div class="input-group">
                    <label for="LoaiSP">Loại Sản Phẩm</label>
                    <input type="text" name="LoaiSP" placeholder="Loại SP" required>
                </div>
                <div class="input-group">
                    <label for="KichCo">Kích Cỡ</label>
                    <input type="text" name="KichCo" placeholder="Nhập kích Cỡ" required>
                </div>
                <div class="input-group">
                    <label for="MauSac">Màu Sắc</label>
                    <input type="text" name="MauSac" placeholder="Màu Sắc" required>
                </div>
                <div class="input-group">
                    <label for="GiaNhap">Giá Nhập</label>
                    <input type="number" step="0.01" name="GiaNhap" placeholder="Giá Nhập" required>
                </div>
                <div class="input-group">
                    <label for="GiaXuat">Giá Xuất</label>
                    <input type="number" step="0.01" name="GiaXuat" placeholder="Giá Bán" required>
                </div>
                <button type="submit" class="submit-btn">Thêm Sản Phẩm</button>
            </form>
        </div>
    </div>
    <div id="addEmpModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Thêm Nhân Viên</h2>
            <form id="addEmpForm">
                <div class="input-group">
                    <label for="UserName">UserName</label>
                    <input type="text" name="UserName" placeholder="Nhập UserName" required>
                </div>
                <div class="input-group">
                    <label for="PassWord">PassWord</label>
                    <input type="text" name="PassWord" placeholder="Nhập Password" required>
                </div>
                <div class="input-group">
                    <label for="HoTen">Họ Tên</label>
                    <input type="text" name="HoTen" placeholder="Nhập Họ Tên" required>
                </div>
                <div class="input-group">
                    <label for="SoDienThoai">Số Điện Thoại</label>
                    <input type="text" name="SoDienThoai" placeholder="Nhập Số Điện Thoại" required>
                </div>
                <button type="submit" class="submit-btn">Thêm Nhân Viên</button>
            </form>
        </div>
    </div>
    <div id="editProductModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chỉnh Sửa Sản Phẩm</h2>
            <form id="editProductForm">
                <div class="input-group">
                    <label for="MaSP">Mã Sản Phẩm</label>
                    <input type="number" name="MaSP" value="${product.MaSP}" readonly>
                </div>
                <div class="input-group">
                    <label for="TenSP">Tên Sản Phẩm</label>
                    <input type="text" name="TenSP" value="${product.TenSP}" required>
                </div>
                <div class="input-group">
                    <label for="LoaiSP">Loại Sản Phẩm</label>
                    <input type="text" name="LoaiSP" value="${product.LoaiSP}" required>
                </div>
                <div class="input-group">
                    <label for="KichCo">Kích Cỡ</label>
                    <input type="text" name="KichCo" value="${product.KichCo}" required>
                </div>
                <div class="input-group">
                    <label for="MauSac">Màu Sắc</label>
                    <input type="text" name="MauSac" value="${product.MauSac}" required>
                </div>
                <div class="input-group">
                    <label for="GiaNhap">Giá Nhập</label>
                    <input type="number" name="GiaNhap" value="${product.GiaNhap}" required>
                </div>
                <div class="input-group">
                    <label for="GiaXuat">Giá Xuất</label>
                    <input type="number" name="GiaXuat" value="${product.GiaXuat}" required>
                </div>
                <div class="input-group">
                    <label for="SoLuongTon">Số Lượng Tồn</label>
                    <input type="number" name="SoLuongTon" value="${product.SoLuongTon}" readonly>
                </div>
                <button type="submit" class="submit-btn">Cập nhật Sản Phẩm</button>
            </form>
        </div>
    </div>
    <div id="editEmpModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chỉnh Sửa Nhân Viên</h2>
            <form id="editEmpForm">
                <div class="input-group">
                    <label for="MaNV">Mã Nhân Viên</label>
                    <input type="number" name="MaNV" value="${emp.MaNV}" readonly>
                </div>
                <div class="input-group">
                    <label for="HoTen">Họ Tên</label>
                    <input type="text" name="HoTen" value="${emp.HoTen}" required>
                </div>
                <div class="input-group">
                    <label for="ChucVu">Chức Vụ</label>
                    <input type="text" name="ChucVu" value="${emp.ChucVu}" readonly>
                </div>
                <div class="input-group">
                    <label for="SoDienThoai">Số Điện Thoại</label>
                    <input type="text" name="SoDienThoai" value="${emp.SoDienThoai}" required>
                </div>
                <button type="submit" class="submit-btn">Cập nhật Nhân Viên</button>
            </form>
        </div>
    </div>
    <div id="detailImportModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h3>Chi tiết sản phẩm nhập kho</h3>
            <table id="detailImportTable" class="product-table">
                <thead>
                    <tr>
                        <th>Mã SP</th>
                        <th>Tên SP</th>
                        <th>Loại SP</th>
                        <th>Kích Cỡ</th>
                        <th>Màu sắc</th>
                        <th>Giá nhập</th>
                        <th>Số lượng Nhập</th>
                    </tr>
                </thead>
                <tbody id="detailImportBody">
                    <!-- Dữ liệu chi tiết sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="detailExportModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">x</span>
            <h3>Chi tiết sản phẩm xuất kho</h3>
            <table id="detailExportTable" class="product-table">
                <thead>
                    <tr>
                        <th>Mã Phiếu Xuất</th>
                        <th>Mã Sản Phẩm</th>
                        <th>Tên Sản Phẩm</th>
                        <th>Số Lượng Xuất</th>
                        <th>Đơn Giá</th>
                        <th>Thành Tiền</th>
                    </tr>
                </thead>
                <tbody id="detailExportBody">
                    <!-- Dữ liệu chi tiết sẽ được điền bằng JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="editAccountModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Chỉnh Sửa Tài Khoản</h2>
            <form id="editAccountForm">
                <input type="hidden" name="UserID">
    
                <div class="input-group">
                    <label for="UserName">Tên tài khoản</label>
                    <input type="text" name="UserName" placeholder="UserName" required>
                </div>
    
                <div class="input-group">
                    <label for="PassWord">Mật khẩu mới</label>
                    <input type="password" name="PassWord" placeholder="Nhập mật khẩu mới (để trống nếu không đổi)">
                </div>
    
                <button type="submit" class="submit-btn">Cập nhật Tài Khoản</button>
            </form>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            console.log("Trang dashboard.html đã tải, đang kiểm tra session...");

            $.ajax({
                url: "api/get_account_self.php",
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (data) {
                    console.log("Phản hồi từ get_account_self.php:", data);
                    if (data.success) {
                        console.log("Session hợp lệ, tải trang mặc định...");
                        loadPage("api/dashboard.php");
                    } else {
                        console.log("Session không hợp lệ, chuyển hướng về login...");
                        window.location.href = "login.html";
                    }
                },
                error: function (xhr, status, error) {
                    console.log("Lỗi khi gọi API:", error);
                    window.location.href = "login.html";
                }
            });

            // Xử lý click menu
            $(".menu-link").click(function (e) {
                e.preventDefault();
                var page = $(this).data("page");
                loadPage(page);
            });
            function showToast(message, isError = false) {
            const toast = $("#toast");
            toast.css("background", isError ? "#dc3545" : "#28a745");
            toast.text(message).fadeIn();

            setTimeout(() => {
                toast.fadeOut();
            }, 3000);
         }
            function loadPage(page) {
                if (page === "api/get_sanpham.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã SP</th>
                                                <th>Tên SP</th>
                                                <th>Loại SP</th>
                                                <th>Kích Cỡ</th>
                                                <th>Màu sắc</th>
                                                <th>Giá nhập</th>
                                                <th>Giá xuất</th>
                                                <th>Số lượng tồn</th>
                                                <th>Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            data.forEach(product => {
                                const isHidden = product.TrangThai === "hide";
                                contentHtml += `
                                    <tr data-id="${product.MaSP}" class="${isHidden ? 'strikethrough' : ''}">
                                        <td>${product.MaSP}</td>
                                        <td>${product.TenSP}</td>
                                        <td>${product.LoaiSP}</td>
                                        <td>${product.KichCo}</td>
                                        <td>${product.MauSac}</td>
                                        <td>${product.GiaNhap.toLocaleString('vi-VN')}</td>
                                        <td>${product.GiaXuat.toLocaleString('vi-VN')}</td>
                                        <td>${product.SoLuongTon}</td>
                                        <td>
                                            <button class="edit-btn" data-id="${product.MaSP}">Sửa</button>
                                            <button class="toggle-btn" data-id="${product.MaSP}" data-status="${product.TrangThai}">
                                                ${isHidden ? 'Hiện' : 'Ẩn'}
                                            </button>
                                            
                                        </td>
                                    </tr>
                                `;
                            });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                    <button id = "addProductBtn", class="addProductBtn">Thêm Sản Phẩm</button>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý sự kiện cho nút Ẩn/Hiện
                            $(".toggle-btn").on("click", function () {
                                const productId = $(this).data("id");
                                const currentStatus = $(this).data("status");
                                const newStatus = currentStatus === "show" ? "hide" : "show";
                                const button = $(this);
                                const row = $(`tr[data-id="${productId}"]`);
                                $.ajax({
                                    url: "api/update_status.php",
                                    type: "POST",
                                    data: { MaSP: productId, TrangThai: newStatus },
                                    success: function (response) {
                                        if (newStatus === "hide") {
                                            row.addClass("strikethrough");
                                            button.text("Hiện").data("status", "hide");
                                        } else {
                                            row.removeClass("strikethrough");
                                            button.text("Ẩn").data("status", "show");
                                        }
                                        loadPage("api/get_sanpham.php");
                                    },
                                    error: function () {
                                        showToast("Lỗi khi cập nhật trạng thái!");
                                    }
                                });
                            });

                            $("#addProductBtn").off("click").on("click", function () {
                                $("#addProductModal").fadeIn();
                            });

                            $(".close").on("click", function () {
                                $("#addProductModal").fadeOut();
                            });

                            $(window).off("click").on("click", function (event) {
                                if ($(event.target).is("#addProductModal")) {
                                    $("#addProductModal").fadeOut();
                                }
                            });

                            $("#addProductForm").off("submit").on("submit", function (event) {
                                event.preventDefault();
                                $.ajax({
                                    type: "POST",
                                    url: "api/addSP.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        showToast(response);
                                        $("#addProductModal").fadeOut();
                                        loadPage("api/get_sanpham.php");
                                    },
                                    error: function () {
                                        showToast("Lỗi khi thêm sản phẩm!");
                                    }
                                });
                            });
                            $(".edit-btn").off("click").on("click", function () {
                                $("#editProductModal").fadeIn();
                                const productId = $(this).data("id");
                                const product = data.find(p => p.MaSP == productId); // Sử dụng == vì MaSP có thể là chuỗi hoặc số

                                $("#editProductForm input[name='MaSP']").val(product.MaSP);
                                $("#editProductForm input[name='TenSP']").val(product.TenSP);
                                $("#editProductForm input[name='LoaiSP']").val(product.LoaiSP);
                                $("#editProductForm input[name='KichCo']").val(product.KichCo);
                                $("#editProductForm input[name='MauSac']").val(product.MauSac);
                                $("#editProductForm input[name='GiaNhap']").val(product.GiaNhap.toLocaleString('vi-VN'));
                                $("#editProductForm input[name='GiaXuat']").val(product.GiaXuat.toLocaleString('vi-VN'));
                                $("#editProductForm input[name='SoLuongTon']").val(product.SoLuongTon);
                                $("#editProductModal").fadeIn();
                            });

                            $(".close").on("click", function () {
                                $("#editProductModal").fadeOut();
                            });

                            $(window).on("click", function (event) {
                                if ($(event.target).is("#editProductModal")) {
                                    $("#editProductModal").fadeOut();
                                }
                            });

                            $("#editProductForm").off("submit").on("submit", function (event) {
                                event.preventDefault();
                                $.ajax({
                                    type: "POST",
                                    url: "api/editSP.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        showToast("Sản phẩm đã được cập nhật!");
                                        $("#editProductModal").fadeOut();
                                        loadPage("api/get_sanpham.php");
                                    },
                                    error: function () {
                                        showToast("Lỗi khi cập nhật sản phẩm!");
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                } 
                else if (page === "api/get_nhap.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Nhập</th>
                                                <th>Mã Nhà Cung Cấp</th>
                                                <th>Ngày Nhập</th>
                                                <th>Mã Nhân Viên</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            data.forEach(nhap => {
                                contentHtml += `
                                    <tr>
                                        <td>${nhap.MaPN}</td>
                                        <td>${nhap.MaNCC}</td>
                                        <td>${nhap.NgayNhap}</td>
                                        <td>${nhap.MaNV}</td>
                                        <td>
                                            <button class="detail-btn" data-id="${nhap.MaPN}">Chi Tiết</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);
                            $(".detail-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/get_chitietnhap.php",
                                    type: "GET",
                                    data: { MaPN: requestId },
                                    dataType: "json",
                                    success: function (response) {
                                        $("#detailImportBody").empty();

                                        // Điền dữ liệu chi tiết vào bảng
                                        if (Array.isArray(response) && response.length > 0) {
                                            response.forEach(product => {
                                                $("#detailImportBody").append(`
                                                    <tr>
                                                        <td>${product.MaSP}</td>
                                                        <td>${product.TenSP}</td>
                                                        <td>${product.LoaiSP}</td>
                                                        <td>${product.KichCo || 'N/A'}</td>
                                                        <td>${product.MauSac}</td>
                                                        <td>${product.GiaNhap.toLocaleString('vi-VN')}</td>
                                                        <td>${product.SoLuongNhap}</td>
                                                    </tr>
                                                `);
                                            });
                                        } else {
                                            $("#detailImportBody").append(`
                                                <tr>
                                                    <td colspan="7">Không có sản phẩm nào cho phiếu nhập này</td>
                                                </tr>
                                            `);
                                        }

                                        // Hiển thị modal
                                        $("#detailImportModal").fadeIn();
                                    },
                                    error: function () {
                                        showToast("Lỗi khi lấy chi tiết sản phẩm nhập kho!");
                                    }
                                });
                            });

                            // Đóng modal khi nhấp nút "x"
                            $("#detailImportModal .close").on("click", function () {
                                $("#detailImportModal").fadeOut();
                            });

                            // Đóng modal khi nhấp ra ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#detailImportModal")) {
                                    $("#detailImportModal").fadeOut();
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                } 
                else if (page === "api/get_xuat.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Xuất</th>
                                                <th>Ngày Xuất</th>
                                                <th>Mã Nhân Viên</th>
                                                <th>Mã Cửa Hàng</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            data.forEach(xuat => {
                                contentHtml += `
                                    <tr>
                                        <td>${xuat.MaPX}</td>
                                        <td>${xuat.NgayXuat}</td>
                                        <td>${xuat.MaNV}</td>
                                        <td>${xuat.MaCH}</td>
                                        <td>
                                            <button class="detail-btn" data-id="${xuat.MaPX}">Chi Tiết</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                    
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);
                            $(".detail-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/get_chitietxuat.php",
                                    type: "GET",
                                    data: { MaPX: requestId },
                                    dataType: "json",
                                    success: function (response) {
                                        $("#detailExportBody").empty();
                                        if (Array.isArray(response) && response.length > 0) {
                                            response.forEach(product => {
                                                $("#detailExportBody").append(`
                                                    <tr>
                                                        <td>${product.MaPX}</td>
                                                        <td>${product.MaSP}</td>
                                                        <td>${product.TenSP}</td>
                                                        <td>${product.SoLuongXuat}</td>
                                                        <td>${product.DonGia.toLocaleString('vi-VN')}</td>
                                                        <td>${product.ThanhTien.toLocaleString('vi-VN')}</td>
                                                    </tr>
                                                `);
                                            });
                                        } else {
                                            $("#detailExportBody").append(`
                                                <tr>
                                                    <td colspan="6">Không có sản phẩm nào cho phiếu xuất này</td>
                                                </tr>
                                            `);
                                        }
                                        $("#detailExportModal").fadeIn();
                                    },
                                    error: function () {
                                        showToast("Lỗi khi lấy chi tiết sản phẩm xuất kho!");
                                    }
                                });
                            });
                            $("#detailExportModal .close").on("click", function () {
                                $("#detailExportModal").fadeOut();
                            });

                            // Đóng modal khi nhấp ra ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#detailExportModal")) {
                                    $("#detailExportModal").fadeOut();
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html("<p>Lỗi khi tải dữ liệu: " + error + "</p>");
                        }
                    });
                } 
                else if (page === "api/dashboard.php") {
                    $.ajax({
                        url: "api/dashboard.php",
                        type: "GET",
                        dataType: "json",
                        success: function (lowStockData) {
                            let contentHtml = `
                                <div class="main-content-1">
                                    <div class="dashboard-box overview">
                                        <h3>Bảng tổng quan</h3>
                                        <div class="chart-controls">
                                            <button id="monthChartBtn" class="active11">1 Tháng</button>
                                            <button id="yearChartBtn" class="active11">1 Năm</button>
                                        </div>
                                        <canvas id="chartNhapXuat"></canvas>
                                    </div>
                                    <div class="dashboard-box chart">
                                        <h3>Biểu đồ nhập xuất kho</h3>
                                        
                                    </div>
                                    <div class="dashboard-box low-stock">
                                        <h3>Sản phẩm gần hết hàng</h3>
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Mã Sản Phẩm</th>
                                                    <th>Tên Sản Phẩm</th>
                                                    <th>Số Lượng Tồn</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;
                            if (Array.isArray(lowStockData) && lowStockData.length > 0) {
                                lowStockData.forEach(product => {
                                    contentHtml += `
                                        <tr>
                                            <td>${product.MaSP}</td>
                                            <td>${product.TenSP}</td>
                                            <td>${product.SoLuongTon}</td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="3">Không có sản phẩm nào gần hết hàng</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);
// Khởi tạo biểu đồ
let chartInstance = null;
const ctx = document.getElementById('chartNhapXuat').getContext('2d');

function loadChartData(period) {
    $.ajax({
        url: "api/dashboard_data.php",
        type: "GET",
        data: { period: period },
        dataType: "json",
        success: function (response) {
            if (response.success) {
                const chartData = response.data;

                // Hủy biểu đồ cũ nếu có
                if (chartInstance) {
                    chartInstance.destroy();
                }

                // Tạo biểu đồ mới
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: 'Đơn Vào',
                                data: chartData.nhap,
                                backgroundColor: 'rgba(76, 175, 80, 0.6)',
                                borderColor: '#388E3C',
                                borderWidth: 2,
                                hoverBackgroundColor: 'rgba(76, 175, 80, 0.8)',
                                hoverBorderColor: '#2E7D32',
                            },
                            {
                                label: 'Đơn Ra',
                                data: chartData.xuat,
                                backgroundColor: 'rgba(255, 87, 51, 0.6)',
                                borderColor: '#D84315',
                                borderWidth: 2,
                                hoverBackgroundColor: 'rgba(255, 87, 51, 0.8)',
                                hoverBorderColor: '#BF360C',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    font: {
                                        size: 14,
                                        family: "'Segoe UI', sans-serif",
                                        weight: 'bold',
                                    },
                                    color: '#333'
                                }
                            },
                            tooltip: {
                                backgroundColor: '#f9f9f9',
                                titleColor: '#333',
                                bodyColor: '#000',
                                borderColor: '#ccc',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: period === 'month' ? 'Ngày' : 'Tháng',
                                    font: {
                                        size: 16,
                                        family: "'Segoe UI', sans-serif",
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#555'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Số lượng',
                                    font: {
                                        size: 16,
                                        family: "'Segoe UI', sans-serif",
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    color: '#555'
                                },
                                beginAtZero: true,
                                grid: {
                                    color: '#eee'
                                }
                            }
                        }
                    }
                });
            } else {
                console.log("Lỗi khi tải dữ liệu biểu đồ: " + response.message);
            }
        },
        error: function () {
            console.log("Lỗi khi kết nối đến server!");
        }
    });
}

                            // Tải dữ liệu mặc định (1 tháng)
                            loadChartData('month');

                            // Xử lý nút chuyển đổi
                            $("#monthChartBtn").off("click").on("click", function () {
                                $(this).addClass("active").siblings().removeClass("active");
                                loadChartData('month');
                            });

                            $("#yearChartBtn").off("click").on("click", function () {
                                $(this).addClass("active").siblings().removeClass("active");
                                loadChartData('year');
                            });
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html(`<p>Lỗi khi tải dữ liệu: ${error}</p>`);
                        }
                    });
                }
                else if (page === "api/get_donhang.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Xuất</th>
                                                <th>Mã Cửa Hàng</th>
                                                <th>Ngày Xuất</th>
                                                <th>Trạng Thái</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(order => {
                                    contentHtml += `
                                        <tr>
                                            <td>${order.MaPX}</td>
                                            <td>${order.MaCH}</td>
                                            <td>${order.NgayXuat}</td>
                                            <td>
                                                ${order.TrangThai === 'pending' ?
                                                    `<button class="approve-btn" data-id="${order.MaPX}">Duyệt</button>` : order.TrangThai}
                                                ${order.TrangThai === 'pending' ?
                                                    `<button class="deny-btn" data-id="${order.MaPX}">Từ chối</button>` : ''}
                                            </td>
                                            <td>
                                                <button class="detail-btn" data-id="${order.MaPX}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="5">Không có đơn hàng đang chờ xử lý</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            $(".approve-btn").on("click", function () {
                                const orderId = $(this).data("id");
                                const currentDate = new Date().toISOString().split('T')[0]; // Lấy ngày hiện tại
                                $.ajax({
                                    url: "api/approve_order.php", // Sửa API cho admin
                                    type: "POST",
                                    data: {
                                        MaPX: orderId,
                                        NgayXuat: currentDate
                                    },
                                    dataType: "json",
                                    success: function (response) {
                                        if (response.success) {
                                            showToast("Phiếu xuất đã được duyệt!");
                                            loadPage("api/get_donhang.php");
                                        } else {
                                            showToast("Duyệt phiếu xuất thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Lỗi khi duyệt:", xhr.responseText);
                                        showToast("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });
                            $(".deny-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/deny_order.php",
                                    type: "POST",
                                    data: { MaPX: requestId },
                                    success: function (response) {
                                        showToast("Đơn Hàng đã bị từ chối!");
                                        loadPage("api/get_donhang.php"); // Tải lại danh sách
                                    },
                                    error: function () {
                                        showToast("Lỗi khi từ chối yêu cầu!");
                                    }
                                });
                            });
                            $(".detail-btn").on("click", function () {
                                const orderId = $(this).data("id");
                                $.ajax({
                                    url: "api/get_chitietdonhang.php", // Sửa API cho admin
                                    type: "GET",
                                    data: { MaPX: orderId },
                                    dataType: "json",
                                    success: function (response) {
                                        console.log("Phản hồi từ get_chitietdonhang.php:", response);
                                        if (response.success) {
                                            $("#detailExportBody").empty(); // Sửa ID modal cho khớp
                                            if (Array.isArray(response.data) && response.data.length > 0) {
                                                response.data.forEach(product => {
                                                    $("#detailExportBody").append(`
                                                        <tr>
                                                            <td>${product.MaPX}</td>
                                                            <td>${product.MaSP}</td>
                                                            <td>${product.TenSP}</td>
                                                            <td>${product.SoLuongXuat}</td>
                                                            <td>${product.DonGia.toLocaleString('vi-VN')}</td>
                                                            <td>${product.ThanhTien.toLocaleString('vi-VN')}</td>
                                                        </tr>
                                                    `);
                                                });
                                            } else {
                                                $("#detailExportBody").append(`
                                                    <tr>
                                                        <td colspan="6">Không có sản phẩm nào cho phiếu xuất này</td>
                                                    </tr>
                                                `);
                                            }
                                            $("#detailExportModal").fadeIn(); // Sửa ID modal
                                        } else {
                                            showToast("Lấy chi tiết thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function (xhr, status, error) {
                                        console.log("Lỗi khi lấy chi tiết:", xhr.responseText);
                                        showToast("Lỗi khi lấy chi tiết phiếu xuất!");
                                    }
                                });
                                
                            });
                            // Đóng modal khi nhấp nút "x"
                            $("#detailExportModal .close").on("click", function () {
                                $("#detailExportModal").fadeOut();
                            });

                            // Đóng modal khi nhấp ra ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#detailExportModal")) {
                                    $("#detailExportModal").fadeOut();
                                }
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log("Lỗi khi tải api/get_donhang.php:", xhr.responseText);
                            $("#content .main-contents").html(`<p>Lỗi khi tải dữ liệu: ${error}</p>`);
                        }
                    });
                }
                else if (page === "api/get_yeucau.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Phiếu Nhập</th>
                                                <th>Nhà Cung Cấp</th>
                                                <th>Ngày Nhập</th>
                                                <th>Mã Nhân Viên</th>
                                                <th>Trạng Thái</th>
                                                <th>Chi Tiết</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            if (Array.isArray(data) && data.length > 0) {
                                data.forEach(request => {
                                    contentHtml += `
                                        <tr>
                                            <td>${request.MaPN}</td>
                                            <td>${request.MaNCC}</td>
                                            <td>${request.NgayNhap}</td>
                                            <td>${request.MaNV}</td>
                                            <td>
                                                <button class="approve-btn" data-id="${request.MaPN}">Duyệt</button>
                                                <button class="deny-btn" data-id="${request.MaPN}">Từ chối</button>
                                            </td>
                                            <td>
                                                <button class="detail-btn" data-id="${request.MaPN}">Chi Tiết</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            } else {
                                contentHtml += `
                                    <tr>
                                        <td colspan="6">Không có yêu cầu nhập kho đang chờ xử lý</td>
                                    </tr>
                                `;
                            }
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý sự kiện nút Duyệt
                            $(".approve-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/approve_request.php",
                                    type: "POST",
                                    data: { MaPN: requestId },
                                    success: function (response) {
                                        showToast("Yêu cầu đã được duyệt!");
                                        loadPage("api/get_yeucau.php"); // Tải lại danh sách
                                    },
                                    error: function () {
                                        showToast("Lỗi khi duyệt yêu cầu!");
                                    }
                                });
                            });
                            $(".deny-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/deny_request.php",
                                    type: "POST",
                                    data: { MaPN: requestId },
                                    success: function (response) {
                                        showToast("Yêu cầu đã bị từ chối!");
                                        loadPage("api/get_yeucau.php"); // Tải lại danh sách
                                    },
                                    error: function () {
                                        showToast("Lỗi khi từ chối yêu cầu!");
                                    }
                                });
                            });
                            $(".detail-btn").on("click", function () {
                                const requestId = $(this).data("id");
                                $.ajax({
                                    url: "api/get_chitietnhap.php",
                                    type: "GET",
                                    data: { MaPN: requestId },
                                    dataType: "json",
                                    success: function (response) {
                                        // Xóa dữ liệu cũ trong bảng chi tiết
                                        $("#detailImportBody").empty();

                                        // Điền dữ liệu chi tiết vào bảng
                                        if (Array.isArray(response) && response.length > 0) {
                                            response.forEach(product => {
                                                $("#detailImportBody").append(`
                                                    <tr>
                                                        <td>${product.MaSP}</td>
                                                        <td>${product.TenSP}</td>
                                                        <td>${product.LoaiSP}</td>
                                                        <td>${product.KichCo || 'N/A'}</td>
                                                        <td>${product.MauSac}</td>
                                                        <td>${product.GiaNhap.toLocaleString('vi-VN')}</td>
                                                        <td>${product.SoLuongNhap}</td>
                                                    </tr>
                                                `);
                                            });
                                        } else {
                                            $("#detailImportBody").append(`
                                                <tr>
                                                    <td colspan="8">Không có sản phẩm nào cho phiếu nhập này</td>
                                                </tr>
                                            `);
                                        }

                                        // Hiển thị modal
                                        $("#detailImportModal").fadeIn();
                                    },
                                    error: function () {
                                        showToast("Lỗi khi lấy chi tiết sản phẩm nhập kho!");
                                    }
                                });
                            });

                            // Đóng modal khi nhấp nút "x"
                            $("#detailImportModal .close").on("click", function () {
                                $("#detailImportModal").fadeOut();
                            });

                            // Đóng modal khi nhấp ra ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#detailImportModal")) {
                                    $("#detailImportModal").fadeOut();
                                }
                            });
                            
                        },
                        error: function (xhr, status, error) {
                            $("#content .main-contents").html(`<p>Lỗi khi tải dữ liệu yêu cầu: ${error}</p>`);
                        }
                    });
                }
                else if (page === "api/get_store.php"){
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Cửa Hàng</th>
                                                <th>Tên Cửa Hàng</th>
                                                <th>Địa Chỉ</th>
                                                <th>Số Diện Thoại</th>
                                                <th>Email</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                                data.forEach(request => {
                                    contentHtml += `
                                        <tr>
                                            <td>${request.MaCH}</td>
                                            <td>${request.TenCH}</td>
                                            <td>${request.DiaChi}</td>
                                            <td>${request.SoDienThoai}</td>
                                            <td>${request.Email}</td>
                                        </tr>
                                    `;
                                });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);
                            
                    }
                });
                }
                else if (page === "api/get_emp.php"){
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>Mã Nhân viên</th>
                                                <th>Họ Tên</th>
                                                <th>Chức Vụ</th>
                                                <th>Số Diện Thoại</th>
                                                <th>Hành Động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                                data.forEach(request => {
                                    contentHtml += `
                                        <tr>
                                            <td>${request.MaNV}</td>
                                            <td>${request.HoTen}</td>
                                            <td>${request.ChucVu}</td>
                                            <td>${request.SoDienThoai}</td>
                                            <td>
                                                <button class="edit-btn" data-id="${request.MaNV}">Sửa Thông Tin</button>
                                            </td>
                                        </tr>
                                    `;
                                });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                    <button id="addEmpBtn" class="addEmpBtn">Thêm Nhân Viên</button>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            $("#addEmpBtn").off("click").on("click", function () {
                            $("#addEmpModal").fadeIn();
                            });

                            // Đóng modal khi nhấn nút "x"
                            $(".close").on("click", function () {
                                $("#addEmpModal").fadeOut();
                                $("#editEmpModal").fadeOut();
                            });

                            // Đóng modal khi click bên ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#addEmpModal")) {
                                    $("#addEmpModal").fadeOut();
                                }
                                if ($(event.target).is("#editEmpModal")) {
                                    $("#editEmpModal").fadeOut();
                                }
                            });

                            // Xử lý submit form thêm nhân viên
                            $("#addEmpForm").off("submit").on("submit", function (event) {
                                event.preventDefault();
                                $.ajax({
                                    type: "POST",
                                    url: "api/addNV.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        if (response.success) {
                                            alert(response.message || "Nhân viên đã được thêm!");
                                            $("#addEmpModal").fadeOut();
                                            loadPage("api/get_emp.php");
                                        } else {
                                            alert("Thêm nhân viên thất bại: " + (response.message || "Lỗi không xác định"));
                                        }
                                    },
                                    error: function () {
                                        alert("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });

                            $(".edit-btn").off("click").on("click", function () {
                                $("#editEmpModal").fadeIn();
                                const empId = $(this).data("id");
                                const emp = data.find(e => e.MaNV == empId);

                                $("#editEmpForm input[name='MaNV']").val(emp.MaNV);
                                $("#editEmpForm input[name='HoTen']").val(emp.HoTen);
                                $("#editEmpForm input[name='ChucVu']").val(emp.ChucVu);
                                $("#editEmpForm input[name='SoDienThoai']").val(emp.SoDienThoai);
                                $("#editEmpModal").fadeIn();
                            });

                            // $(".close").on("click", function () {
                            //     $("#editEmpModal").fadeOut();
                            // });

                            // $(window).on("click", function (event) {
                            //     if ($(event.target).is("#editEmpModal")) {
                            //         $("#editEmpModal").fadeOut();
                            //     }
                            // });

                            $("#editEmpForm").on("submit", function (event) {
                                event.preventDefault();
                                $.ajax({
                                    type: "POST",
                                    url: "api/editNV.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        showToast("Nhân viên đã được cập nhật!");
                                        $("#editEmpModal").fadeOut();
                                        loadPage("api/get_emp.php");
                                    },
                                    error: function () {
                                        showToast("Lỗi khi cập nhật Nhân viên!");
                                    }
                                });
                            });
                            
                    }
                });
                }
                else if (page === "api/get_account.php") {
                    $.ajax({
                        url: page,
                        type: "GET",
                        dataType: "json",
                        success: function (data) {
                            let contentHtml = `
                                <div class="table-container">
                                    <table class="product-table">
                                        <thead>
                                            <tr>
                                                <th>UserID</th>
                                                <th>UserName</th>
                                                <th>Role</th>
                                                <th>Hành Động</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;

                            data.forEach(request => {
                                const isBanned = request.TrangThai === "banned";
                                contentHtml += `
                                    <tr data-id="${request.UserID}" class="${isBanned ? 'strikethrough' : ''}">
                                        <td>${request.UserID}</td>
                                        <td>${request.UserName}</td>
                                        <td>${request.Role}</td>
                                        <td>
                                            <button class="edit-btn" data-id="${request.UserID}">Sửa</button>
                                            <button class="toggle-btn" data-id="${request.UserID}" data-status="${request.TrangThai}">
                                                ${isBanned ? 'Mở' : 'Cấm'}
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                            contentHtml += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            $("#content .main-contents").html(contentHtml);

                            // Xử lý sự kiện cho nút Toggle (Ban/UnBan)
                            $(".toggle-btn").on("click", function () {
                                const userId = $(this).data("id"); // Sử dụng userId thay vì productId
                                const currentStatus = $(this).data("status");
                                const newStatus = currentStatus === "normal" ? "banned" : "normal"; // Chuyển giữa "banned" và "normal"
                                const button = $(this);
                                const row = $(`tr[data-id="${userId}"]`);
                                $.ajax({
                                    url: "api/update_account_status.php",
                                    type: "POST",
                                    data: { UserID: userId, TrangThai: newStatus }, // Sử dụng UserID thay vì MaSP
                                    success: function (response) {
                                        if (newStatus === "banned") {
                                            row.addClass("strikethrough");
                                            button.text("UnBan").data("status", "banned");
                                        } else {
                                            row.removeClass("strikethrough");
                                            button.text("Ban").data("status", "normal");
                                        }
                                        loadPage("api/get_account.php");
                                    },
                                    error: function () {
                                        showToast("Lỗi khi kết nối đến server!");
                                    }
                                });
                            });
                            $(".edit-btn").off("click").on("click", function () {
                                const userId = $(this).data("id");
                                const account = data.find(a => a.UserID == userId);

                                if (!account) {
                                    showToast("Không tìm thấy tài khoản với ID: " + userId);
                                    return;
                                }

                                // Điền dữ liệu vào form
                                $("#editAccountForm input[name='UserID']").val(account.UserID);
                                $("#editAccountForm input[name='UserName']").val(account.UserName);
                                $("#editAccountForm input[name='PassWord']").val(""); // Để trống để người dùng nhập mật khẩu mới

                                // Hiển thị modal
                                $("#editAccountModal").fadeIn();
                            });

                            // Đóng modal khi nhấn nút "x"
                            $(".close").on("click", function () {
                                $("#editAccountModal").fadeOut();
                            });

                            // Đóng modal khi click bên ngoài
                            $(window).on("click", function (event) {
                                if ($(event.target).is("#editAccountModal")) {
                                    $("#editAccountModal").fadeOut();
                                }
                            });

                            // Xử lý submit form chỉnh sửa tài khoản
                            $("#editAccountForm").off("submit").on("submit", function (event) {
                                event.preventDefault(); // Ngăn form gửi theo cách thông thường

                                // Gửi AJAX để cập nhật tài khoản
                                $.ajax({
                                    type: "POST",
                                    url: "api/editAccount.php",
                                    data: $(this).serialize(),
                                    success: function (response) {
                                        if (response.success) {
                                            showToast("Tài khoản đã được cập nhật!"); // ✅ thay showToast
                                            $("#editAccountModal").fadeOut();
                                            loadPage("api/get_account.php");
                                        } else {
                                            showToast("Cập nhật thất bại: " + (response.message || "Lỗi không xác định"), true); // ✅ thay showToast
                                        }
                                    },
                                    error: function () {
                                        showToast("Lỗi khi kết nối đến server!", true); // ✅ thay showToast
                                    }
                                });
                            });
                        },
                        error: function (xhr, status, error) {
                            console.log("Error: " + error); // Debug lỗi từ API
                        }
                    });
                }
                else {
                    $("#content .main-contents").load(page);
                }
            }
        });


    </script>
    <div id="toast" style="display:none; position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; z-index: 9999;"></div>
 
</body>

</html>